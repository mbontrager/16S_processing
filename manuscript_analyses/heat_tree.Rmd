#E affinis 16S analysis
### Martin Bontrager
### 30 October 2015

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs_heat_tree/',
                      echo=FALSE, warning=FALSE, message=FALSE)
```

```{r read_data}
library(DESeq2)
library(phyloseq)
library(RColorBrewer)
library(ggplot2)
library(plyr)
library(tidyr)
library(ape)
library(dplyr)
library(reshape2)
library(knitr)

set.seed(9373399)
#setwd("Projects/16S_Eaffinis/Analyses/2015-11-23_UPARSE/")

otuTable <- read.csv("data/otus.csv", header = TRUE, row.names = 1)
taxTable <- read.csv("data/taxa.csv", quote = '"')
sampleData <- read.csv("data/sampleData.csv")
tree <- read.tree("data/tree.tre")
rownames(sampleData) <- sampleData[, 1]
sampleData <- sampleData[, -1]
taxmat <- as.matrix(taxTable)
rownames(taxmat) <- taxmat[, 1]
taxmat <- taxmat[, -1]


otuTable <- otu_table(otuTable, taxa_are_rows = FALSE)
taxTable <- tax_table(taxmat)

physeq <- phyloseq(otuTable, taxTable, tree)
sample_data(physeq) <- sampleData

## Standardize abundances by relative abundance:
physeq_relative <- transform_sample_counts(physeq, function(x) x / sum(x))

rm(taxmat, sampleData, otuTable, taxTable, tree)

## Variance Stabilized sample counts with DESeq2 (per "waste not, want not" paper)
pseq_deseq <- phyloseq_to_deseq2(physeq, ~Environment)

# calculate geometric means prior to estimate size factors
gm_mean = function(x, na.rm=TRUE){
  exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x))
}
geoMeans <- apply(counts(pseq_deseq), 1, gm_mean)

#Dispersion Estimates in DESeq2
pseq_vst <- estimateSizeFactors(pseq_deseq, geoMeans = geoMeans)
pseq_vst <- estimateDispersions(pseq_vst)
pseq_vst <- getVarianceStabilizedData(pseq_vst)

#Replace physeq object OTU table with variance transformed values
physeq_vst <- physeq
otu_table(physeq_vst) <- otu_table(pseq_vst, taxa_are_rows = TRUE)

rm(pseq_vst, geoMeans, pseq_deseq)
```


```{r ggplottheme}
# ## ggplot theming
theme_set(theme_bw())
pal = "Set1"
scale_colour_discrete <- function(palname = pal, ...) {
        scale_colour_brewer(palette = palname, ...)
}

scale_fill_discrete <- function(palname = pal, ...) {
        scale_fill_brewer(palette = palname, ...)
}

getPalette <- colorRampPalette(brewer.pal(9, "Set1"))

# Plot title size, etc.
fontsize = 18L
theme_update(axis.title.x = element_text(size=fontsize))
theme_update(axis.title.y = element_text(size=fontsize))
theme_update(plot.title = element_text(size=fontsize+2))
```

#Heatmaps

I'll create another phyloseq object with only the top 400 OTUs (by overall abundance). Exactly how to subset these data is not immediately obvious. The authors of phyloseq suggest that I might remove OTUs that occur less than three times in at most 80% of samples. Such taxa might have an abnormally large coefficient of variation.  I'm not sure about that. I can test that later if necessary

```{r transform_and_prune}
# Top400 OTUs by overall abundance
top400 <- prune_taxa(names(sort(taxa_sums(physeq_vst), decreasing = TRUE)[1:400]),
                     physeq_vst)
## Standardize by relative abundance
#top400 <- transform_sample_counts(top400, function(x) x / sum(x))
```

```{r NMDS_bray_heatmap}
ordered_samples <- as.vector((read.table("data/samples.txt"))[, 1])
plot_heatmap(top400,"NMDS", "bray", sample.order = ordered_samples) +
    theme(axis.title.y = element_text(size=20),
          axis.title.x = element_text(size=20),
          plot.title = element_text(size=24, face="bold", vjust=2))

plot_heatmap(top400,"NMDS","unifrac", sample.order = ordered_samples) + 
    ggtitle("NMDS w/ Unweighted UniFrac") +
    theme(axis.title.y = element_text(size=20),
          axis.title.x = element_text(size=20),
          axis.text.x = element_text(size=14),
          legend.position = "none",
          plot.title = element_text(size=24, face="bold", vjust=2))
```

#Network Plots
```{r network, include=FALSE}
unifrac_unweighted <- UniFrac(physeq, weighted = FALSE)
net <- make_network(physeq, distance = unifrac_unweighted, max.dist = 0.9)
plot_network(net, physeq)

plot_net(physeq_relative, maxdist = 0.7, color = "Environment", shape = "WaterType") + ggtitle(label = "Bray-Curtis")
plot_net(physeq_relative, maxdist = 0.9, distance = "jaccard", point_label = "Location", color = "Environment", shape = "WaterType") + ggtitle(label = "Jaccard")
plot_net(physeq_relative, maxdist = 0.03, distance = "gower", point_label = "Location", color = "Environment", shape = "WaterType") + ggtitle(label = "Gower")
plot_net(physeq, maxdist = 0.75, distance = unifrac_unweighted, point_label = "Location", color = "Environment", shape = "WaterType") + ggtitle(label = "Unifrac")
```

#Phylogenetic Trees

Here are some explorations of the data with trees. First I need to subset the data to only the top 50 most abundant taxa.

These trees are really busy, and probably only really useful to me. 
```{r trees}
# Top50 OTUs by overall abundance
top50 <- prune_taxa(names(sort(taxa_sums(physeq), decreasing = TRUE)[1:50]), physeq)

# Standardize by relative abundance
top50 <- transform_sample_counts(top50, function(x) x / sum(x))
plot_tree(top50, nodelabf = nodeplotboot(), ladderize="left", 
          label.tips="Phylum", color="Environment", size="abundance", shape="WaterType")
```